<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cast Vote</title>
    <link rel="icon" href="assets/logo.jpg">
    <link rel="stylesheet" href="assets/styles.css">

    <style>
        header { text-align:center; margin-top:20px; }
        header h1 { color:#9fdcff; margin-bottom:8px; }
        header .top-links a {
            margin:0 12px; color:#00cfff; font-size:14px; text-decoration:none;
        }
        header .top-links a:hover { text-decoration:underline; }

        .card {
            width:420px; margin:25px auto; padding:30px;
            background:rgba(5,20,45,0.6);
            border-radius:16px;
            box-shadow:0 0 35px rgba(0,200,255,0.25);
        }

        input[readonly] {
            background:rgba(15,23,42,0.8);
            color:#9fbcd4; cursor:not-allowed; margin-bottom:18px;
        }

        .candidate-card {
            display:flex; align-items:center; gap:15px;
            background:#0b1f3a; padding:12px;
            border-radius:10px; margin-bottom:12px;
            cursor:pointer; transition:0.2s;
        }

        .candidate-card:hover { background:#12335e; }

        .candidate-card img {
            width:70px; height:70px; border-radius:50%;
            object-fit:cover; border:2px solid #00cfff;
        }

        .candidate-card input { transform:scale(1.3); }

        .candidate-info b { font-size:17px; color:#e5f3ff; }
        .candidate-info small { color:#9fbcd4; }

        .btn { width:100%; margin-top:15px; }
        .warning { margin-top:12px; min-height:18px; }
    </style>
</head>
<body>

<header>
    <h1 id="electionTitle">Loading Election...</h1>
    <div class="top-links">
        <a href="results.html">üìä View Live Results</a>
        <a href="/">üè† Home</a>
    </div>
</header>

<div class="card">
    <input id="enrollment" readonly>
    <div id="candidates"></div>
    <button class="btn" id="voteBtn">Cast Vote</button>
    <p id="msg" class="warning"></p>
</div>

<script>
const API = "http://localhost:5000";

const enrollmentInput = document.getElementById("enrollment");
const candidatesDiv = document.getElementById("candidates");
const msg = document.getElementById("msg");
const voteBtn = document.getElementById("voteBtn");

/* =====================================================
   LOGIN CHECK
   ===================================================== */
const voterIdRaw = sessionStorage.getItem("voter_id");
const storedEnrollment = sessionStorage.getItem("enrollment");

if (!voterIdRaw || !storedEnrollment) {
    alert("‚ùå Unauthorized access. Please login first.");
    window.location.href = "/voter_auth.html";
}

const voterId = parseInt(voterIdRaw, 10);
if (isNaN(voterId)) {
    alert("‚ùå Invalid voter session. Please login again.");
    sessionStorage.clear();
    window.location.href = "/voter_auth.html";
}

enrollmentInput.value = storedEnrollment;

/* =====================================================
   LOAD ELECTION + STATUS + CANDIDATES
   ===================================================== */
async function loadVotePage() {
    try {
        const eRes = await fetch(API + "/admin/current_election");
        const eData = await eRes.json();

        if (!eData.exists) {
            document.getElementById("electionTitle").innerText = "No Active Election";
            return;
        }

        document.getElementById("electionTitle").innerText = `üó≥Ô∏è ${eData.title}`;
        const electionId = eData.id;

        const statusRes = await fetch(`${API}/voter/status/${voterId}`);
        const statusData = await statusRes.json();

        if (statusData.has_voted) {
            msg.style.color = "#f87171";
            msg.innerText = "‚ùå You have already voted";
            voteBtn.disabled = true;
            voteBtn.innerText = "Vote Already Cast";
            candidatesDiv.style.opacity = "0.6";
            candidatesDiv.style.pointerEvents = "none";
            return;
        }

        const cRes = await fetch(`${API}/voter/get_candidates/${electionId}`);
        const cData = await cRes.json();

        candidatesDiv.innerHTML = "";

        if (!cData.length) {
            candidatesDiv.innerHTML = "<p>No candidates available.</p>";
            return;
        }

        cData.forEach(c => {
            candidatesDiv.innerHTML += `
            <label class="candidate-card">
                <input type="radio" name="candidate" value="${c.on_chain_id}">
                <img src="${c.photo || 'assets/default_candidate.png'}">
                <div class="candidate-info">
                    <b>${c.name}</b><br>
                    <small>${c.party || ""}</small>
                </div>
            </label>`;
        });

    } catch (err) {
        console.error(err);
        msg.style.color = "#f87171";
        msg.innerText = "‚ùå Error loading election data.";
    }
}

loadVotePage();

/* =====================================================
   CAST VOTE (SAFE)
   ===================================================== */
voteBtn.onclick = async () => {

    const selected = document.querySelector("input[name=candidate]:checked");
    if (!selected) {
        msg.style.color = "#f87171";
        msg.innerText = "‚ùå Please select a candidate";
        return;
    }

    const candidateId = parseInt(selected.value, 10);
    if (isNaN(candidateId)) {
        msg.style.color = "#f87171";
        msg.innerText = "‚ùå Invalid candidate selection";
        return;
    }

    voteBtn.disabled = true;
    msg.style.color = "#9fbcd4";
    msg.innerText = "‚è≥ Casting your vote on blockchain...";

    try {
        const res = await fetch(API + "/voter/vote", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                voter_id: voterId,
                candidate_id: candidateId
            })
        });

        const data = await res.json();

        if (res.ok) {
            msg.style.color = "#00ff9d";
            msg.innerText = "‚úÖ Vote cast successfully!";
            setTimeout(() => window.location.href = "results.html", 1500);
        } else {
            voteBtn.disabled = false;
            msg.style.color = "#f87171";
            msg.innerText = data.error || "Vote failed";
        }

    } catch (err) {
        console.error(err);
        voteBtn.disabled = false;
        msg.style.color = "#f87171";
        msg.innerText = "‚ùå Server error";
    }
};
</script>

</body>
</html>
